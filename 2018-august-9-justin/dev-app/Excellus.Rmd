---
title: "Opioid Epidemic Dashboard"
resource_files:
- Excellus_dashboard_implementation.R
- ICD codes for Opioids.xlsx
- testtable.csv
- final.RData
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: column
    theme: cerulean
---

```{r setup, include=FALSE}
library(flexdashboard)
library(rmarkdown)
library(shiny)
library(dplyr)
library(sp)
library(raster)
library(maptools)
library(leaflet)
library(RColorBrewer)
library(tigris)
library(rgdal)
library(shinythemes)
library(reshape2)
library(rCharts)
library(knitr)
library(kableExtra)
library(DT)
library(shinyBS)
#library(plyr)
#library(quantmod)
```

```{r, echo=FALSE}

#load(file="C:/Users/mpatel2/Desktop/Excellus_data_preprocessing/final.RData")
load(file="final.RData")
#load(file ='Trend.RData')

```


```{r}

County_Payer<- c('County','Payer')
visits<- list(
  'Emergency Room'= c('PainandAbuse.ER.visits','Total.ER.visits','PainandAbuse.ER.visit.rate','Diagnosis.ER.visits','Diagnosis.ER.visit.rate','PainAbuseDiagnosis.ER.visits','PainAbuseDiagnosis.ER.visit.rate'),
  'Inpatient' =
    c('PainandAbuse.Inpatient.visits','Total.Inpatient.visits','PainandAbuse.Inpatient.visit.rate','Diagnosis.Inpatient.visits','Diagnosis.Inpatient.visit.rate','PainAbuseDiagnosis.Inpatient.visits','PainAbuseDiagnosis.Inpatient.visit.rate'),
  'Outpatient' = 
    c('PainandAbuse.Outpatient.visits','Total.Outpatient.visits','PainandAbuse.Outpatient.visit.rate','Diagnosis.Outpatient.visits','Diagnosis.Outpatient.visit.rate','PainAbuseDiagnosis.Outpatient.visits','PainAbuseDiagnosis.Outpatient.visit.rate'),
  'Professional' = 
    c('PainandAbuse.Professional.visits','Total.Professional.visits','PainandAbuse.Professional.visit.rate','Diagnosis.Professional.visits','Diagnosis.Professional.visit.rate','PainAbuseDiagnosis.Professional.visits','PainAbuseDiagnosis.Professional.visit.rate'),
  'Other' = 
    c('PainandAbuse.Other.visits','Total.Other.visits','PainandAbuse.Other.visit.rate','Diagnosis.Other.visits','Diagnosis.Other.visit.rate','PainAbuseDiagnosis.Other.visits','PainAbuseDiagnosis.Other.visit.rate')
  
)

levels(Excellus$Payer)[levels(Excellus$Payer)=="Direct Pay Hmo"] <- "Direct Pay HMO"
levels(Excellus$Payer)[levels(Excellus$Payer)=="Direct Pay Pos"] <- "Direct Pay POS"
levels(Excellus$Payer)[levels(Excellus$Payer)=="Ssa"] <- "SSA"
#levels(Excellus$Payer)[levels(Excellus$Payer)=="<Unknown>"] <- "Unknown"
#remove the Unknown Payer1
#Excellus$Payer<- Excellus$Payer[!Excellus$Payer%in%c('<Unknown>')]

#payer <- c('Child Health Plus', 'Commercial', 'Direct Pay HMO', 'Direct Pay POS', 'Family Health Plus', 'Healthy New York','Healthy New York Plus', 'Basic Health Plan', 'Medicaid','Medicare', 'SSA', "Valumed", "Unknown")
payer <- c('Child Health Plus', 'Commercial', 'Direct Pay HMO', 'Direct Pay POS', 'Family Health Plus', 'Healthy New York','Healthy New York Plus', 'Basic Health Plan', 'Medicaid','Medicare', 'SSA', "Valumed")

dependency_grouping <- c("Pain and Abuse","Poisoning by Opiates")

```

Opioid-Related Facility Visits {data-orientation=column}
=======================================================================


#Column { .tabset .tabset-fade} 
-----------------------------------------------------------------------
### ![](./Standard-Excellus-Logo-Small.png) Opioid Epidemic Map


```{r}



# Excellus

ui<- fluidPage(
  fluidRow(

    tags$head(
      # Include our custom CSS
      #includeCSS("C:/Users/mpatel2/Desktop/Excellus_data_preprocessing/styles.css")
      includeCSS("styles.css")
      #  includeScript("gomap.js")
    ),
    #width=12, height=650,#650 px
    
    leafletOutput('map', height = '563px', width = '1200px'), # chip added with
    
    absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE, draggable = TRUE, top = 60, left = "auto", right = 20, bottom = "auto", width = 330, height= "auto",
                  h2("Map Explorer Panel"),
                  
                  selectInput("year", 
                              label = h4("Year"), 
                              choices = as.character(c(2010:2017)),
                              selected =" 2010"),
                  tags$style(type='text/css', ".selectize-dropdown-content {max-height: 400px; }"),
                  
                  #options(shiny.sanitize.errors = TRUE),
                  
                  selectInput("visit", h4("Visit Type:"), choices = names(visits), selected = names(visits)[1], multiple=TRUE, selectize = TRUE),
                  
                  selectInput("payer", h4("Line of Business:"), choices= payer, selected = "Commercial",multiple=TRUE, selectize = TRUE),
                  
                   selectInput("dependency_grouping", h4("Opioid Grouping:"), choices= dependency_grouping, selected = "Pain and Abuse",multiple=TRUE, selectize = TRUE),
                  
                  actionButton("goButton", "Go!", icon("paper-plane"), style="color: #fff; background-color: #084594; border-color: #2e6da4"),
                  p("Click the button to update the value displayed in the Map Explorer Panel.")                                    
    ),
      conditionalPanel(
         condition = "input.dependency_grouping == 'Pain and Abuse'",

    absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE, draggable = TRUE, bottom = 0 , right = "auto", left = -5, top = "auto", width = 760, height= 10,
                 tags$p(tags$strong(tags$u("Indexed Pain and Abuse Visit Rate")),tags$strong(": "), tags$i(tags$span(style="color:red",'Normalized mean for the Pain and Abuse visit and line of business selected per 1000 people for Excellus counites')))
                  
                  
              
                  
                  
    )
 ),
   conditionalPanel(
         condition = "input.dependency_grouping == 'Poisoning by Opiates'",

    absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE, draggable = TRUE, bottom = 0 , right = "auto", left = -5, top = "auto", width = 760, height= 10,
                 tags$p(tags$strong(tags$u("Indexed Poisoning by Opiates Visit Rate")),tags$strong(": "), tags$i(tags$span(style="color:red",'Normalized mean for the Poisoning by Opiates visit and line of business selected per 1000 people for Excellus counites')))
                  
                  
              
                  
                  
    )
 ), 
 
     conditionalPanel(
         condition = "input.dependency_grouping.length == 2",

    absolutePanel(id = "controls", class = "panel panel-default", fixed = TRUE, draggable = TRUE, bottom = 0 , right = "auto", left = -5, top = "auto", width = 760, height= 10,
                 tags$p(tags$strong(tags$u("Indexed Pain and Abuse/Poisoning by Opiates Visit Rate")),tags$strong(": "), tags$i(tags$span(style="color:red",'Normalized mean for the Indexed Pain and Abuse/Poisoning by Opiates visit and line of business selected per 1000 people for Excellus counites')))
                  
                  
              
                  
                  
    )
 ) 

  ))


# Define server logic required to draw a histogram
server <- function(input, output) {
  
   print("hi****************4 ") 
  df<- eventReactive(input$goButton,{

    if(length(input$visit)==0 & length(input$payer)==0)
    {
      stop(safeError('Please select a "Visit" and a "Line of Business" in the Map Explorer Panel'))
    }
    else if(length(input$payer)==0)
    {
      stop(safeError('Please select a "Line of Business" in the Map Explorer Panel'))
    }
    else if(length(input$visit)==0)
    { 
      stop(safeError('Please select a "Visit" in the Map Explorer Panel'))
    }
    
     
 
if("Pain and Abuse" %in% input$dependency_grouping  && !("Poisoning by Opiates" %in% input$dependency_grouping)) {

  if(length(input$visit)==1)
    { 
      #opioid_df$Year<- as.character(opioid_df$Year)
      if(length(input$payer)==1)
      { 

        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits)==input$visit]))]
    df[is.na(df)] <- 0
         return(df)
      }
      
      else
      { 
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits)==input$visit]))]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:5)]
        df$County<- as.character(df$County)
        df[,5]<- (df[,3]/df[,4])*1000
        
        return(df)
      }
    }
    else if(length(input$visit)==2)
    { 
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
       
        df[is.na(df)]<-0
        df$County<- as.character(df$County)
        print(c("df3",df))
        #df<- df[,-c(6,7)]
        df[,3]<- df[,3]+df[,10]
        print(c("df4",df[,3]))
        df[,4]<- df[,4] + df[,11]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6,7)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df[is.na(df)]<- 0
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df<- df[,c(1,2,3:13)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,3]+df[,10]
        df[,4]<- df[,4] + df[,11]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    else if(length(input$visit)==3)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
        df[,3]<- df[,3]+df[,10]+df[,17]
        df[,4]<- df[,4] + df[,11]+df[,18]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:20)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,3]+df[,10]+df[,17]
        df[,4]<- df[,4] + df[,11]+df[,18]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    
    else if(length(input$visit)==4)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
        df[,3]<- df[,3]+df[,10]+df[,17]+df[,24]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:27)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,3]+df[,10]+df[,17]+df[,24]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    
    else if(length(input$visit)==5)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
        print(c("df1",str(df)))
        df[,3]<- df[,3]+df[,10]+df[,17]+df[,24]+df[,31]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]+df[,32]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:34)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,3]+df[,10]+df[,17]+df[,24]+df[,31]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]+df[,32]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
 
    }
    
}
    else if (!("Pain and Abuse" %in% input$dependency_grouping)  && "Poisoning by Opiates" %in% input$dependency_grouping) {

  if(length(input$visit)==1)
    { 
      #opioid_df$Year<- as.character(opioid_df$Year)
      if(length(input$payer)==1)
      { 

        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits)==input$visit]))]
 df<- df[,c(1,2,6,4,7)]       
print(c("df",df))

         return(df)
      }
      
      else
      { 
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits)==input$visit]))]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        print("Hello to")
        df[is.na(df)]<-0
        
        df<- df[,c(1:6)]
        
        df$County<- as.character(df$County)
        df[,3] <- df[,6]
        df[,5]<- (df[,6]/df[,4])*1000
        df[is.na(df)] <- 0
        return(df)
      }
    }
    else if(length(input$visit)==2)
    { 
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
       
        df[is.na(df)]<-0
        print(c("df2",head(df)))
        df$County<- as.character(df$County)
        print(c("df3",df))
        #df<- df[,-c(6,7)]
        df[,3]<- df[,6]+df[,13]
        print(c("df4",df[,3]))
        df[,4]<- df[,4] + df[,11]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6,7)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df[is.na(df)]<- 0
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        
        df<- df[,c(1,2,3:13)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,6]+df[,13]
        df[,4]<- df[,4] + df[,11]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    else if(length(input$visit)==3)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]

        df[,3]<- df[,6]+df[,13]+df[,20]
        df[,4]<- df[,4] + df[,11]+df[,18]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:20)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,6]+df[,13]+df[,20]
        df[,4]<- df[,4] + df[,11]+df[,18]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    
    else if(length(input$visit)==4)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
                        print(c("df3",df))

        df[,3]<- df[,6]+df[,13]+df[,20]+df[,27]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:27)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,6]+df[,13]+df[,20]+df[,27]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    
    else if(length(input$visit)==5)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
        print(c("df1",str(df)))
        df[,3]<- df[,6]+df[,13]+df[,20]+df[,27]+df[,34]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]+df[,32]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:34)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,6]+df[,13]+df[,20]+df[,27]+df[,34]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]+df[,32]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
 
    }
    
}
       
     else if ("Pain and Abuse" %in% input$dependency_grouping  && "Poisoning by Opiates" %in% input$dependency_grouping) {
print("Pineapple")
  if(length(input$visit)==1)
    { 
      #opioid_df$Year<- as.character(opioid_df$Year)
      if(length(input$payer)==1)
      { 

        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits)==input$visit]))]
df<- df[,c(1,2,8,4,9)]
print(c("df",df))
         return(df)
      }
      
      else
      { 
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits)==input$visit]))]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:8)]
        print(c("df1",df))
        df$County<- as.character(df$County)
        df[,3] <- df[,8]
        df[,5]<- (df[,8]/df[,4])*1000
        
        return(df)
      }
    }
    else if(length(input$visit)==2)
    { 
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
       
        df[is.na(df)]<-0
        df$County<- as.character(df$County)
        #df<- df[,-c(6,7)]
        df[,3]<- df[,8]+df[,15]
        df[,4]<- df[,4] + df[,11]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6,7)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df[is.na(df)]<- 0
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        
        df<- df[,c(1,2,3:15)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,8]+df[,15]
        df[,4]<- df[,4] + df[,11]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    else if(length(input$visit)==3)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
        df[,3]<- df[,8]+df[,15]+df[,22]
        df[,4]<- df[,4] + df[,11]+df[,18]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:22)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,8]+df[,15]+df[,22]
        df[,4]<- df[,4] + df[,11]+df[,18]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    
    else if(length(input$visit)==4)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
        df[,3]<- df[,8]+df[,15]+df[,22]+df[,29]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:29)]
        df$County<- as.character(df$County)
        
        df[,3]<- df[,8]+df[,15]+df[,22]+df[,29]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
      
    }
    
    else if(length(input$visit)==5)
    {
      
      if(length(input$payer)==1)
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer==input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        df[is.na(df)]<-0
        #df<- df[,-c(6:7, 11:12)]
        print(c("df1",str(df)))
        df[,3]<- df[,8]+df[,15]+df[,22]+df[,29]+df[,36]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]+df[,32]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      else
      {
        df<- Excellus[(Excellus$Year==input$year & Excellus$Payer %in% input$payer), c(County_Payer,unlist(visits[names(visits) %in% input$visit]))]
        #df<- df[,-c(6:7, 11:12)]
        df <- df %>% group_by(County) %>% summarise_each(funs(sum), -Payer)
        df<- as.data.frame(append(df, list(Payer=paste0(input$payer, collapse = ' and ')), after = 1))
        df[is.na(df)]<-0
        df<- df[,c(1:36)]
        df$County<- as.character(df$County)

        df[,3]<- df[,8]+df[,15]+df[,22]+df[,29]+df[,36]
        df[,4]<- df[,4] + df[,11]+df[,18]+df[,25]+df[,32]
        df[,5]<- (df[,3]/df[,4])*1000
        return(df[,c(1:5)])
      }
      
 
    }
    
}
  }, ignoreNULL = FALSE) 


   map<- reactive({

    counties2<- counties_spatial_df
     df<- df()
     df[is.na(df)] <- 0
 
     df<- df[,c(1:5)]
     
     colnames(df)[colnames(df)=='County']<-'NAME_2'
     counties2@data <- counties2@data %>% left_join(df, by = c('NAME_2'))
print(c("Banana1",counties2@data[,20]))
     counties2@data$Actual.Opioid.Visit.Rate<- counties2@data[,20]
print(c("Banana2",mean(counties2@data[,20])))
     counties2@data[,20]<- (counties2@data[,20]/mean(counties2@data[,20], na.rm=TRUE))*100
     
counties2@data[is.na(counties2@data)] <- 0
    return(counties2)
     

   })

  

   output$map<- renderLeaflet({
     if ("Pain and Abuse" %in% input$dependency_grouping  && !("Poisoning by Opiates" %in% input$dependency_grouping)) {

    
    pal <- colorNumeric(
      palette = "viridis",#Blue#Reds
      domain = map()@data[,20])

    print(c("Test1",map()@data[,20]))
    print("1")
    
    
   # prettyNum(map()@data[,20], big.mark = ",")
   # CartoDB.DarkMatter #Esri.WorldGrayCanvas##7f0000
    leaflet(map()) %>% addProviderTiles('HikeBike.HikeBike') %>% 
      setView(lat = 42.85, lng = -76.1474, zoom = 7) %>%
      addPolygons(fillColor = ~pal(map()@data[,20])
                  ,fillOpacity = 0.7
                  ,color =  'white'#"#03F"   #"black" 
                  ,weight = 1.5
                  ,dashArray='4'
                  ,popup = paste0(
                    "<span style='color: #2c7fb8'><strong>",map()@data$NAME_2,"</span></strong><br><strong>", 'Total number of Visits: ', "</strong>",prettyNum(map()@data[,19], big.mark = ","),"<br><strong>",'Number of Visits with Pain and Abuse Code: ', "</strong>",prettyNum(map()@data[,18], big.mark = ","),"<br><strong>",'Pain and Abuse Visit rate: ', "</strong>",round(map()@data$Actual.Opioid.Visit.Rate,3),"<br><strong>",'Indexed Pain and Abuse Visit rate: ', "</strong>",round(map()@data[,20],1),  "<br><strong>", "Excellus Region: " ,"</strong>", map()@data$region
                  )
     ) %>% addLegend(position = "topleft",
                      pal = pal, values = ~map()@data[,20]
                      ,title = 'Indexed Pain and Abuse Visit <br>Rate per 1000: ') %>% 
      addPolygons(data = Excellus_regions.polygons, fill = FALSE, color = '#f93', weight = 5)#"#084594"
     } else if (!("Pain and Abuse" %in% input$dependency_grouping)  && "Poisoning by Opiates" %in% input$dependency_grouping) { 
     
   
    pal <- colorNumeric(
      palette = "viridis",#Blue#Reds
      domain = map()@data[,20])

   #  print(c(input$dependency_grouping,map()@data[,20])) #Test1 # Chip Edit
    
   #  print("2")
    
    
   # prettyNum(map()@data[,20], big.mark = ",")
   # CartoDB.DarkMatter #Esri.WorldGrayCanvas##7f0000
    leaflet(map()) %>% addProviderTiles('HikeBike.HikeBike') %>% 
      setView(lat = 42.85, lng = -76.1474, zoom = 7) %>%
      addPolygons(fillColor = ~pal(map()@data[,20])
                  ,fillOpacity = 0.7
                  ,color =  'white'#"#03F"   #"black" 
                  ,weight = 1.5
                  ,dashArray='4'
                  ,popup = paste0(
                    "<span style='color: #2c7fb8'><strong>",map()@data$NAME_2,"</span></strong><br><strong>", 'Total number of Visits: ', "</strong>",prettyNum(map()@data[,19], big.mark = ","),"<br><strong>",'Number of Visits with Diagnosis Code: ', "</strong>",prettyNum(map()@data[,18], big.mark = ","),"<br><strong>",'Diagnosis Visit rate: ', "</strong>",round(map()@data$Actual.Opioid.Visit.Rate,3),"<br><strong>",'Indexed Diagnosis Visit rate: ', "</strong>",round(map()@data[,20],1),  "<br><strong>", "Excellus Region: " ,"</strong>", map()@data$region
                  )
     ) %>% addLegend(position = "topleft",
                      pal = pal, values = ~map()@data[,20]
                      ,title = 'Indexed Diagnosis Visit <br>Rate per 1000: ') %>% 
      addPolygons(data = Excellus_regions.polygons, fill = FALSE, color = '#f93', weight = 5)#"#084594"
       
     } else if("Pain and Abuse" %in% input$dependency_grouping  && "Poisoning by Opiates" %in% input$dependency_grouping) {
 
    
    
    pal <- colorNumeric(
      palette = "viridis",#Blue#Reds
      domain = map()@data[,20])

   #  print(c("Test1",map()@data[,20]))
   #  print("3")
    
   # prettyNum(map()@data[,20], big.mark = ",")
   # CartoDB.DarkMatter #Esri.WorldGrayCanvas##7f0000
    leaflet(map()) %>% addProviderTiles('HikeBike.HikeBike') %>% 
      setView(lat = 42.85, lng = -76.1474, zoom = 7) %>%
      addPolygons(fillColor = ~pal(map()@data[,20])
                  ,fillOpacity = 0.7
                  ,color =  'white'#"#03F"   #"black" 
                  ,weight = 1.5
                  ,dashArray='4'
                  ,popup = paste0(
                    "<span style='color: #2c7fb8'><strong>",map()@data$NAME_2,"</span></strong><br><strong>", 'Total number of Visits: ', "</strong>",prettyNum(map()@data[,19], big.mark = ","),"<br><strong>",'Number of Visits with PainAbuseDiagnosis Code: ', "</strong>",prettyNum(map()@data[,18], big.mark = ","),"<br><strong>",'PainAbuseDiagnosis Visit rate: ', "</strong>",round(map()@data$Actual.Opioid.Visit.Rate,3),"<br><strong>",'Indexed PainAbuseDiagnosis Visit rate: ', "</strong>",round(map()@data[,20],1),  "<br><strong>", "Excellus Region: " ,"</strong>", map()@data$region
                  )
     ) %>% addLegend(position = "topleft",
                      pal = pal, values = ~map()@data[,20]
                      ,title = 'Indexed PainAbuseDiagnosis Visit <br>Rate per 1000: ') %>% 
      addPolygons(data = Excellus_regions.polygons, fill = FALSE, color = '#f93', weight = 5)#"#084594"
       
     }
  })
  

 
}
shinyApp(ui = ui, server = server)
```



### ![](./tab-filler.png) Dataset


#### Opioid-Related Facility Visits in Excellus Counties ####{style="text-align:center"}

#### ####{style="text-align:left"}


```{r}

renderDataTable({
  
  Excellus$Year<-as.factor(as.character(Excellus$Year))
  Excellus$County<- as.factor(Excellus$County)
  Excellus$Payer<- as.factor(Excellus$Payer)
  
    Excellus[,c(8,9,15,16,22,23,29,30,36,37,43,44)]<- round(Excellus[,c(8,9,15,16,22,23,29,30,36,37,43,44)],3)
    pain <- mean(Excellus$PainandAbuse.ER.visit.rate)
    print(c("JackFruit",pain)) 
    print(c("Index1",Excellus$PainandAbuse.ER.visit.rate))

    Excellus$PainandAbuse.Indexed.ER.rate<- as.integer((Excellus$PainandAbuse.ER.visit.rate/mean(Excellus$PainandAbuse.ER.visit.rate, na.rm=TRUE))*100)
    print(c("Index1",Excellus$PainandAbuse.ER.visit.rate))
     Excellus$Diagnosis.Indexed.ER.rate<- as.integer((Excellus$Diagnosis.ER.visit.rate/mean(Excellus$Diagnosis.ER.visit.rate, na.rm=TRUE))*100)
      
      
    Excellus$PainandAbuse.Indexed.Inpatient.rate<- as.integer((Excellus$PainandAbuse.Inpatient.visit.rate/mean(Excellus$PainandAbuse.Inpatient.visit.rate, na.rm=TRUE))*100)
    Excellus$Diagnosis.Indexed.Inpatient.rate<- as.integer((Excellus$Diagnosis.Inpatient.visit.rate/mean(Excellus$Diagnosis.Inpatient.visit.rate, na.rm=TRUE))*100)
   
    
    Excellus$PainandAbuse.Indexed.Outpatient.rate<- as.integer((Excellus$PainandAbuse.Outpatient.visit.rate/mean(Excellus$PainandAbuse.Outpatient.visit.rate, na.rm=TRUE))*100)
    Excellus$Diagnosis.Indexed.Outpatient.rate<- as.integer((Excellus$Diagnosis.Outpatient.visit.rate/mean(Excellus$Diagnosis.Outpatient.visit.rate, na.rm=TRUE))*100)
    
    
    Excellus$PainandAbuse.Indexed.Professional.rate<- as.integer((Excellus$PainandAbuse.Professional.visit.rate/mean(Excellus$PainandAbuse.Professional.visit.rate, na.rm=TRUE))*100)
    Excellus$Diagnosis.Indexed.Professional.rate<- as.integer((Excellus$Diagnosis.Professional.visit.rate/mean(Excellus$Diagnosis.Professional.visit.rate, na.rm=TRUE))*100)
    
    
    Excellus$PainandAbuse.Indexed.Other.rate<- as.integer((Excellus$PainandAbuse.Other.visit.rate/mean(Excellus$PainandAbuse.Other.visit.rate, na.rm=TRUE))*100)
    
    Excellus$Diagnosis.Indexed.Other.rate<- as.integer((Excellus$Diagnosis.Other.visit.rate/mean(Excellus$Diagnosis.Other.visit.rate, na.rm=TRUE))*100)
    
    
    Excellus$PainandAbuse.Indexed.Overall.rate<- as.integer((Excellus$PainandAbuse.Overall.visit.rate/mean(Excellus$PainandAbuse.Overall.visit.rate, na.rm=TRUE))*100)
    Excellus$Diagnosis.Indexed.Overall.rate<- as.integer((Excellus$Diagnosis.Overall.visit.rate/mean(Excellus$Diagnosis.Overall.visit.rate, na.rm=TRUE))*100)
    
    
    
    Excellus_display<- Excellus[, c(1:5,7:9,46,47,11,12,14:16,49,50,18,19,21:23,52,53,25,26,28:30,55,56,32,33,35:37,58,59,39,40,42:44,61,62 )]
  print(c("Apple",head(Excellus_display)))
    colnames(Excellus_display)<-c('Year','County', 'Line of Business',
                                  'Pain and Abuse  ER Visit', 'Poisoning by Opiates ER Visit', 'Total ER Visit', 'Pain and Abuse ER Visit Rate per 1000', 'Poisoning by Opiates ER Visit Rate per 1000','Pain and Abuse Indexed ER Rate','Poisoning by Opiates Indexed ER Rate',
                                  'Pain and Abuse Inpatient Visits', 'Poisoning by Opiates Inpatient Visits', 'Total Inpatient Visits', 'Pain and Abuse Inpatient Visit Rate per 1000', 'Poisoning by Opiates Inpatient Visit Rate per 1000', 'Pain and Abuse Indexed Inpatient Rate', 'Poisoning by Opiates Indexed Inpatient Rate', 
                                  'Pain and Abuse Outpatient Visit', 'Poisoning by Opiates Outpatient Visit', 'Total Outpatient Visit','Pain and Abuse Outpatient Visit Rate per 1000','Poisoning by Opiates Outpatient Visit Rate per 1000', 'Pain and Abuse Indexed Outpatient Rate', 'Poisoning by Opiates Indexed Outpatient Rate', 
                                  'Pain and Abuse Professional Visit', 'Poisoning by Opiates Professional Visit', 'Total Professional Visit','Pain and Abuse Professional Visit Rate per 1000','Poisoning by Opiates Professional Visit Rate per 1000', 'Pain and Abuse Indexed Professional Rate', 'Poisoning by Opiates Indexed Professional Rate', 
                                  'Pain and Abuse Other Visit', 'Poisoning by Opiates Other Visit', 'Total Other Visit','Pain and Abuse Other Visit Rate per 1000','Poisoning by Opiates Other Visit Rate per 1000', 'Pain and Abuse Indexed Other Rate', 'Poisoning by Opiates Indexed Other Rate', 
                                  'Pain and Abuse Overall Visit', 'Poisoning by Opiates Overall Visit', 'Total Overall Visit', 'Pain and Abuse Overall Visit Rate per 1000', 'Poisoning by Opiates Overall Visit Rate per 1000','Pain and Abuse Indexed Overall Rate','Poisoning by Opiates Indexed Overall Rate')
  


    datatable(Excellus_display, filter='top',options = list(autoWidth=TRUE, columnDefs = list(list(width='110px', className = 'dt-center', targets = c(1:45))),scrollX=TRUE, scrollY='300px')) %>%
      formatCurrency(c('Pain and Abuse  ER Visit', 'Poisoning by Opiates ER Visit', 'Total ER Visit', 'Pain and Abuse ER Visit Rate per 1000', 'Poisoning by Opiates ER Visit Rate per 1000','Pain and Abuse Indexed ER Rate','Poisoning by Opiates Indexed ER Rate',
                                  'Pain and Abuse Inpatient Visits', 'Poisoning by Opiates Inpatient Visits', 'Total Inpatient Visits', 'Pain and Abuse Inpatient Visit Rate per 1000', 'Poisoning by Opiates Inpatient Visit Rate per 1000', 'Pain and Abuse Indexed Inpatient Rate', 'Poisoning by Opiates Indexed Inpatient Rate', 
                                  'Pain and Abuse Outpatient Visit', 'Poisoning by Opiates Outpatient Visit', 'Total Outpatient Visit','Pain and Abuse Outpatient Visit Rate per 1000','Poisoning by Opiates Outpatient Visit Rate per 1000', 'Pain and Abuse Indexed Outpatient Rate', 'Poisoning by Opiates Indexed Outpatient Rate', 
                                  'Pain and Abuse Professional Visit', 'Poisoning by Opiates Professional Visit', 'Total Professional Visit','Pain and Abuse Professional Visit Rate per 1000','Poisoning by Opiates Professional Visit Rate per 1000', 'Pain and Abuse Indexed Professional Rate', 'Poisoning by Opiates Indexed Professional Rate', 
                                  'Pain and Abuse Other Visit', 'Poisoning by Opiates Other Visit', 'Total Other Visit','Pain and Abuse Other Visit Rate per 1000','Poisoning by Opiates Other Visit Rate per 1000', 'Pain and Abuse Indexed Other Rate', 'Poisoning by Opiates Indexed Other Rate', 
                                  'Pain and Abuse Overall Visit', 'Poisoning by Opiates Overall Visit', 'Total Overall Visit', 'Pain and Abuse Overall Visit Rate per 1000', 'Poisoning by Opiates Overall Visit Rate per 1000','Pain and Abuse Indexed Overall Rate','Poisoning by Opiates Indexed Overall Rate'), '')
  }, options= list(
    
    
    pageLength=10
    
  )
  )

```


### ![](./tab-filler.png) Data Dictonary



```{r}

shinyApp(
  
  ui = fluidPage(
    
    fluidRow(
      column(6, offset=4, HTML('<font color="#317ec8"><h4 style="text-align:center">Opioid-Related Facility Visits in Excellus Counties</h4></font>'))
      
      
    ),
    fluidRow(column(12,br())),
    
    fluidRow(
      column(12, tableOutput("try"))
    )
    
  )
  ,
  
  server = function(input, output){
    
    output$try<- renderTable({
      
      print(opioid_df_dictionary[-2,])
    })
  }
  
)

```

### ![](./tab-filler.png) ICD Codes


```{r}

shinyApp(
  
  ui = fluidPage(
    
    fluidRow(
      column(6, offset=4, HTML('<font color="#317ec8"><h4 style="text-align:center">ICD Codes for Opioid-Related Facility Visits in Excellus Counties</h4></font>'))
      
      
    ),
    fluidRow(column(12,br())),
    
    fluidRow(
      column(12, tableOutput("try"))
    )
    
  )
  ,
  
  server = function(input, output){
    
    output$try<- renderTable({
      
      print(ICD_codes)
    })
  }
  
)


```


### ![](./tab-filler.png)  Term Significance

#### Definition of the Metrics on the Map ####{style="text-align:center"}

#### {style="text-align:left"}


```{r}

renderTable({
  
  colnames(facility_visits_df)<-c('Year','County',"Geography" ,'Line of Business','ER Visit-Opioid', 'Total ER Visit','Opioid ER Visit Rate per 1000')
  
  print(head(facility_visits_df[(facility_visits_df$County %in% c('Albany','Bronx') & facility_visits_df$Year=='2015') ,c('Year','County', 'Line of Business','ER Visit-Opioid', 'Total ER Visit','Opioid ER Visit Rate per 1000')],10))
  })

```


```{r}
tags$hr(style="border-color: darkblue")
```
\ 

\[
\begin{eqnarray}
Opioid\ ER\ Visit\ Rate\ for\ a\ Line\ of\ Business\ for\ a\ County\ _{Year}& = & \dfrac {No.\ of\ ER\ visits\ for\ opioid\ abuse\ for\ Line\ of\ Business\ _{Year}\  } {Total\ ER\ visits\ for\ that\ county\ _{Year}}\hspace{10mm} *\ \ 1000\\
\end{eqnarray}
\]

\

\[
\begin{eqnarray}
Opioid\ ER\ Visit\ Rate\ for\ a\ Line\ of\ Business\ for\ Albany\ _{2015}& = & \frac {37}{36,091}\ *\ 1000\\& \\& \approx & 1.02
\end{eqnarray}
\]


```{r}
tags$hr(style="border-color: darkblue")
```

\ 

\[
\begin{eqnarray}
Opioid\ ER\ Visit\ Rate\ across\ all\ the\ Line\ of\ Business\ for\ a\ County\ _{Year}& = & \dfrac {\sum\limits_{i\ \in\  (Commercial,\  Medicaid,\  Medicare,\ Professional,\ Other\ )}\ No.\ of\ ER\ visits\ for\ opioid\ abuse\ _{i,\ Year\ }\  } {\sum\limits_{i\ \in\  (Commercial,\  Medicaid,\  Medicare,\ Professionl,\ Other\ )}\ Total\ ER\ visits\ for\ that\ county\ _{i,\ Year}} *\ \ 1000\\
\end{eqnarray}
\]

\


\[
\begin{eqnarray}
Opioid\ ER\ Visit\ Rate\ across\ all\ the\ Line\ of\ Business\ for\ Albany\ _{Year}& = & \dfrac {37\ +\ 39\ +\ 9\ +\ 3\ +\ 0\ } {(\ 36,091\ +\ 41,299\ +\ 20,079\ +\ 2,384\ +\ 17\ )\ } *\ \ 1000\\& \\& \approx & 0.88
\end{eqnarray}
\]


```{r}
tags$hr(style="border-color: darkblue")
```
\

\[
\begin{eqnarray}
Indexed\ Opioid\ ER\ Visit\ Rate\ for\ a\ Line\ of\ Business\ for\ a\ County\ _{2015}& = & \frac {Opioid\ ER\ Visit\ Rate\ for\ a\ Line\ of\ Business\ for\ a\ County\ _{2015} }{mean\ (Opioid\ ER\ Visit\ Rate\ for\ a\ Line\ of\ Business\ across\ all\ the\ Counties\ _{2015} }\ *\ 100\\
\end{eqnarray}
\]

\

\
\[
\begin{eqnarray}
Indexed\ Opioid\ ER\ Visit\ Rate\ for\ a\ Line\ of\ Business\ for\ Albany\ _{2015}& = & \frac {1.02}{(\ 1.02\ +\ 0.26\ )\ /\ 2 }\ *\ 100\\& \approx &\ 79.68
\end{eqnarray}
\]

\





Opioid Trends
=======================================================================

#Column { .tabset .tabset-fade} 
-----------------------------------------------------------------------
### ![](./Standard-Excellus-Logo-Small.png) Pain and Abuse Trends Plots


```{r}

shinyApp(
  
  ui = fluidPage(
  
    fluidRow(
      column(2, offset=3, HTML('<font color="#084594"><b>Select the Facility Visit: </b></font>')),
      column(3, selectInput('id', label=NULL, choices = c('Pain and Abuse ER Visit Rate','Pain and Abuse Inpatient Visit Rate', 'Pain and Abuse Outpatient Visit Rate',"Pain and Abuse Professional Visit Rate", "Pain and Abuse Other Visit Rate",'Pain and Abuse Overall Visit Rate'), selected='Pain and Abuse ER Visit Rate'))
      
      
    
  ),
    fluidRow(
    column(6, showOutput("nplot01", "highcharts" )),
    
    column(6, showOutput("nplot02", "highcharts" ))
    #showOutput("nplot01", "highcharts" ) 
  ),
  
  tags$br(),
  tags$hr(style="border-color: darkblue"),
  
  fluidRow(
    column(6, showOutput("nplot03", "highcharts" )),
    column(6, showOutput("nplot04", "highcharts" ))
    #showOutput("nplot01", "highcharts" ) 
  )
  
  
  )
    ,
  
  server = function(input, output){
    
    visit<- reactive({
      return(list(input$id, paste0(input$id,' per 1000')))
    })
    output$nplot01 <- renderChart2({
      c<- Excellus_all_region

      df3<- c[c$variable==visit()[[1]],]
      
      colnames(df3)[colnames(df3)=='value']<- visit()[[2]]

      x1<- hPlot(x='Year', y=visit()[[2]] ,group='Region', data= df3, type='line', title=paste0(input$id,' for 2010-2017'), subtitle = 'By Region ')
      x1$params$width <- 642
      x1$params$height <- 540
      x1
    })

    output$nplot02 <- renderChart2({
      c<- Excellus_all_payers

      df3<- c[c$variable==visit()[[1]],]
      colnames(df3)[colnames(df3)=='value']<- visit()[[2]]
      
      x1<- hPlot(x='Year', y=visit()[[2]] ,group='Payer', data= df3, type='line', title=paste0(input$id,' for 2010-2017'), subtitle = 'Line of Business')
      x1$params$width <- 642
      x1$params$height <- 540
      x1
    })
    
 output$nplot03 <- renderChart2({
  c<- Excellus_all_region
  df3<- c[c$variable==visit()[[1]],]
  
  x1<- hPlot(`Percent Change`~Year, group='Region', data= df3, type='column', title=paste0('Percent Change in ',input$id,' for 2011-2017'), subtitle = 'By Region ')
  x1$params$width <- 642
  x1$params$height <- 540
  x1
})

       
    output$nplot04 <- renderChart2({
    c<- Excellus_all_payers
  df3<- c[c$variable==visit()[[1]],]
  
  x1<- hPlot(`Percent Change`~Year, group='Payer', data= df3, type='column', title=paste0('Percent Change in ',input$id,' for 2011-2017'), subtitle = 'Line of Business')
  x1$params$width <- 642
  x1$params$height <- 540
  x1
    })
  }
  
)

```

### ![](./tab-filler.png) Poisoning by Opiates Trends Plots

```{r}

shinyApp(
  
  ui = fluidPage(
  
    fluidRow(
      column(2, offset=3, HTML('<font color="#084594"><b>Select the Facility Visit: </b></font>')),
      column(3, selectInput('id', label=NULL, choices = c('Poisoning by Opiates ER Visit Rate','Poisoning by Opiates Inpatient Visit Rate', 'Poisoning by Opiates Outpatient Visit Rate','Poisoning by Opiates Professional Visit Rate', 'Poisoning by Opiates Other Visit Rate','Poisoning by Opiates Overall Visit Rate'), selected='Poisoning by Opiates ER Visit Rate'))
      
      
    
  ),
    fluidRow(
    column(6, showOutput("nplot01", "highcharts" )),
    
    column(6, showOutput("nplot02", "highcharts" ))
    #showOutput("nplot01", "highcharts" ) 
  ),
  
  tags$br(),
  tags$hr(style="border-color: darkblue"),
  
  fluidRow(
    column(6, showOutput("nplot03", "highcharts" )),
    column(6, showOutput("nplot04", "highcharts" ))
    #showOutput("nplot01", "highcharts" ) 
  )
  
  
  )
    ,
  
  server = function(input, output){
    
    visit<- reactive({
      return(list(input$id, paste0(input$id,' per 1000')))
    })
    output$nplot01 <- renderChart2({
      c<- Excellus_all_region

      df3<- c[c$variable==visit()[[1]],]
      colnames(df3)[colnames(df3)=='value']<- visit()[[2]]
      x1<- hPlot(x='Year', y=visit()[[2]] ,group='Region', data= df3, type='line', title=paste0(input$id,' for 2010-2017'), subtitle = 'By Region ')
      x1$params$width <- 642
      x1$params$height <- 540
      x1
    })

    output$nplot02 <- renderChart2({
      c<- Excellus_all_payers
      df3<- c[c$variable==visit()[[1]],]
      colnames(df3)[colnames(df3)=='value']<- visit()[[2]]
      
      x1<- hPlot(x='Year', y=visit()[[2]] ,group='Payer', data= df3, type='line', title=paste0(input$id,' for 2010-2017'), subtitle = 'Line of Business')
      x1$params$width <- 642
      x1$params$height <- 540
      x1
    })
    
 output$nplot03 <- renderChart2({
  c<- Excellus_all_region
  df3<- c[c$variable==visit()[[1]],]
  
  x1<- hPlot(`Percent Change`~Year, group='Region', data= df3, type='column', title=paste0('Percent Change in ',input$id,' for 2011-2017'), subtitle = 'By Region ')
  x1$params$width <- 642
  x1$params$height <- 540
  x1
})

       
    output$nplot04 <- renderChart2({
    c<- Excellus_all_payers
   
  df3<- c[c$variable==visit()[[1]],]
  
  x1<- hPlot(`Percent Change`~Year, group='Payer', data= df3, type='column', title=paste0('Percent Change in ',input$id,' for 2011-2017'), subtitle = 'Line of Business')
  x1$params$width <- 642
  x1$params$height <- 540
  x1
    })
  }
  
)
```

### ![](./tab-filler.png) Combined Trends Plots

```{r}

shinyApp(
  
  ui = fluidPage(
  
    fluidRow(
      column(2, offset=3, HTML('<font color="#084594"><b>Select the Facility Visit: </b></font>')),
      column(3, selectInput('id', label=NULL, choices = c('Combined ER Visit Rate','Combined Inpatient Visit Rate', 'Combined Outpatient Visit Rate','Combined Professional Visit Rate', 'Combined Other Visit Rate','Combined Overall Visit Rate'), selected='Combined ER Visit Rate'))
      
      
    
  ),
    fluidRow(
    column(6, showOutput("nplot01", "highcharts" )),
    
    column(6, showOutput("nplot02", "highcharts" ))
    #showOutput("nplot01", "highcharts" ) 
  ),
  
  tags$br(),
  tags$hr(style="border-color: darkblue"),
  
  fluidRow(
    column(6, showOutput("nplot03", "highcharts" )),
    column(6, showOutput("nplot04", "highcharts" ))
    #showOutput("nplot01", "highcharts" ) 
  )
  
  
  )
    ,
  
  server = function(input, output){
    
    visit<- reactive({
      return(list(input$id, paste0(input$id,' per 1000')))
    })
    output$nplot01 <- renderChart2({
      c<- Excellus_all_region

      df3<- c[c$variable==visit()[[1]],]
      
      colnames(df3)[colnames(df3)=='value']<- visit()[[2]]

      x1<- hPlot(x='Year', y=visit()[[2]] ,group='Region', data= df3, type='line', title=paste0(input$id,' for 2010-2017'), subtitle = 'By Region ')
      x1$params$width <- 642
      x1$params$height <- 540
      x1
    })

    output$nplot02 <- renderChart2({
      c<- Excellus_all_payers
      df3<- c[c$variable==visit()[[1]],]
      colnames(df3)[colnames(df3)=='value']<- visit()[[2]]
      
      x1<- hPlot(x='Year', y=visit()[[2]] ,group='Payer', data= df3, type='line', title=paste0(input$id,' for 2010-2017'), subtitle = 'Line of Business')
      x1$params$width <- 642
      x1$params$height <- 540
      x1
    })
    
 output$nplot03 <- renderChart2({
  c<- Excellus_all_region
  df3<- c[c$variable==visit()[[1]],]
  
  x1<- hPlot(`Percent Change`~Year, group='Region', data= df3, type='column', title=paste0('Percent Change in ',input$id,' for 2011-2017'), subtitle = 'By Region ')
  x1$params$width <- 642
  x1$params$height <- 540
  x1
})

       
    output$nplot04 <- renderChart2({
    c<- Excellus_all_payers
  df3<- c[c$variable==visit()[[1]],]
  
  x1<- hPlot(`Percent Change`~Year, group='Payer', data= df3, type='column', title=paste0('Percent Change in ',input$id,' for 2011-2017'), subtitle = 'Line of Business')
  x1$params$width <- 642
  x1$params$height <- 540
  x1
    })
  }
  
)
```


About {data-orientation=columns}
=====================================  

Row {data-height=900}
-----------------------------------------------------------------------
#### ![image alt >](./Ad-logo-small-horizontal.png) Executive Summary  

#### Project Objectives  

The objective of this project is to offer descriptive analytics, correlated analytics and a predictive intelligent model of the opioid-related facility (i.e., Emergency Room and providers' offices) visits of Excellus members across Excellus covered regions. 

This project comprises of three phases: 

1. Phase I: Descriptive Analytics: - Provide a descriptive analysis of how New York State and Excellus regions do on opioid related facility visits (i.e. emergency department) and opioid related fatalities 

2. Phase II: Correlated Analytics: - Correlate Excellus providers and opioid-related visits and fatalities based geospatial mapping of Excellus regions. 

3. Phase III: Predictive Modeling - Build predictive model based on Excellus dataset to show significant indicators based on opioid related visits, opioid prescriptions, age, gender, long-duration prescription and providers' behaviors.

#### Background  

This project explores the impact of opioid-related facility visits within the Excellus regions. The Analytics & Data team has designed a descriptive model in which our Behavioral Health team can compare the impact of opioid-related facility visits in each Excellus counties. The dashboard tool comprises of Geospatial mapping of Excellus regions for opioid-related facility visits. The dashboard also provides year-by-year comparisons of Excellus regions against various opioid-related facility visits and additionally allows users to filter out columns/rows as per user needs and download the filtered data so that they can better explore the dataset. 
The dashboard deals with replicating New York State Opioid dashboard in Phase I over the internal Excellus data. Claims data were extracted from the EDW Oracle and classified every claim as being a opioid or non-opioid claim based on the opioid-related ICD 9 or 10 diagnosis codes.
 

#### Dasboard Layout

The interactive dashboard APP is organized into two section:


1.  Geospatial mapping of Excellus counties. It consists of four tabs:

  
    1.1. Opioid Epidemic Map: Opioid Epidemic Map: Overall opioid visit rate by grouping each county and line of business. This helps to summarize data across multiple years and different line of business.
  
  
    1.2. Dataset: Shows and load the actual dataset used in the app. This helps to summarize data across multiple years and multiple line of business.
  
  
    1.3. Data Dictionary which will contain information about all the features included in the dataset. 
  
  
    1.4. ICD Codes: Presents the opioid-related ICD codes that were used for extracting claims related to the ER, inpatient, Outpatient, Profession and Other  opioid-related facility visits. 
  
  
    1.5. Term Significance: Present the definition of the Metrics used on the Map.


2.  Trend
    
    2.1. It shows  line charts in the dashboard that would help the users to perform year-by-year comparison of various facility visits such as ER, 
    Inpatient, and Outpatient across different Excellus regions. 
  

  
    2.2. Similarly, one can perform a year-by-year comparison of opioid-related facility visit rate across different lines of business such as Commercial, Medicare, Medicaid, Professional and Other.




##### EDW Tables and Logic used.



---
output: html_document
# output: pdf_document
---

```{r}
#dd<-read.csv("/users/amooman/WORK/Opioid/Excellus_opoiod_final_Dec28th/Excellus_March19/testtable.csv")

sas_logic %>% 
  knitr::kable("html", escape = F) %>%
  # knitr::kable("latex", escape = F) %>%
  #kable_styling(full_width = F)
  kable_styling(c("striped", "bordered"),full_width = F) %>%
  column_spec(1:2,bold=T) %>%
  row_spec(1:18,bold=T, color = "#145B3D", background ="#DF8F33")
```

There are various conditions that we have to take into consideration while extracting opioid and non- opioid claims data. Below are all the conditions that we are going to consider:

1. We have to make sure that we are extracting medical claims:

    T_CLAIM_LINE_FACT.SRC_APPL_CODE NOT IN (  'FLRX',  'MEDIMPACT',  'ESI’)


2. If we are extracting claims data for a specific year we have to make sure that claims paid date and service effective date should be in that year. Additionally we extract claims where the target claim status is F:

	  T_CLAIM_LINE_FACT.CLM_LINE_PAID_DATE_SK BETWEEN &start_date. AND &end_date.
    T_CLAIM_LINE_FACT.CLM_SRVC_EFF_DATE_SK BETWEEN &start_date. AND &end_date.
    V_CLM_STS_CODE.TRGT_CLM_STS = 'F'


3. We only extract ER, Inpatient and Outpatient claims:

    T_HCG_MR_LINE_DIM.SETTING_DESC IN (  'Inpatient', 'Outpatient', 'Professional' ) OR T_HCG_MR_LINE_DIM.HCG_CODE IN ('13','39')

4. We only extract Commercial, Medicaid and Medicare claims:

    T_PRODUCT_DIM.BSNS_SGMNT IN ('Child Health Plus', 'Commercial', 'Direct Pay HMO', 'Direct Pay POS', 'Family Health Plus', 'Healthy New York','Healthy New York Plus', 'Basic Health Plan', 'Medicaid','Medicare', 'SSA', "Valumed")


5. To make sure we extract only the relevant claims we add the below condition:

    T_CLAIM_LINE_FACT.MBR_DIM_SK>1 and  T_MEMBER_DIM.PRSN_UNIQ_ID not = \<UNK\>


Below is the condition that we take into consideration while extracting county information for a claim:

6. We have to ensure that the claims effective date is between member address effective date and member address through date. The idea is that the claims date should be between the member's start and end address date. There are cases when the claims generate multiple counties and we deal with this problem by just extracting any one of the member county.


    EACH_INDIVIDUAL_FILES_GENERATED_IN_PART_1.CLM_SRVC_EFF_DATE_SK between
    T_MEMBER_ADDRESS_FACT.MBR_ADRS_EFF_DATE_SK and
    T_MEMBER_ADDRESS_FACT.MBR_ADRS_EFF_THRU_DATE_SK

